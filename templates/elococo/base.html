{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="icon" href="{% static random_footer_logo %}"/>
    <meta charset="UTF-8">
    <title>{{ website_title }}</title>
    <link rel="stylesheet" href="{% static "sass/bootstrap_custom.css" %}">
    <link rel="stylesheet" href="{% static "css/base.css" %}">
    <link rel="stylesheet" href="{% static "css/catalogue.css" %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
</head>
<body>

{% include "elococo/navbar.html" %}

{% if messages %}
    {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
            {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}Important: {% endif %}
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<main class="{% spaceless %}{% block body_class %}main_expand_right{% endblock %}{% endspaceless %}">
    {% block base_container %}
    {% endblock %}
</main>

{% include "elococo/footer.html" %}


<div class="modal fade" id="basket-modal" tabindex="-1" aria-labelledby="basket-modal" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Mon Panier</h3>
            </div>
            <div id="basket-form">
                <div class="modal-body">
                    <div class="spinner-border text-success" role="status">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>

<script type="application/javascript">
    // From IB - {% now "Y" %}

    let basket_modal = document.getElementById('basket-modal');
    let basket_modal_showed = false;
    let basket_save_button = false;
    let url_get_basket = "{{ url_get_basket }}";
    let url_get_booking = "{{ url_get_booking }}";
    let httpRequest = new XMLHttpRequest();
    let spinner = basket_modal.querySelector(".modal-body").cloneNode(true);
    let modal_footer_clone = basket_modal.querySelector(".modal-footer").cloneNode(true);
    let modal_form_container = document.getElementById("basket-form");

    function add_save_button(footer) {
        return function listener() {
            if (basket_save_button) {
                return;
            }

            basket_save_button = true;
            let submit_button = document.createElement("button");
            submit_button.setAttribute("type", "submit")
            submit_button.classList.add("btn", "btn-info");
            text = document.createTextNode("Sauvegarder les changements");
            submit_button.appendChild(text);
            footer.appendChild(submit_button);
            footer.classList.remove("is-hidden");
        }
    }

    function create_form_csrf(csrf, url) {
        let form = document.createElement("form");
        form.setAttribute("action", url);
        form.setAttribute("method", "post");
        form.appendChild(csrf_input(csrf));
        return form;
    }

    function csrf_input(csrf) {
        let input_csrf = document.createElement("input");
        input_csrf.setAttribute("type", "hidden");
        input_csrf.setAttribute("name", "csrfmiddlewaretoken");
        input_csrf.setAttribute("value", csrf);
        return input_csrf
    }

    function construct_basket_form(basket) {
        let errors_form = null;
        let modal_form_container_footer = modal_footer_clone.cloneNode();
        modal_form_container_footer.classList.add("btn", "is-hidden");
        let table = document.createElement("table");
        table.classList.add("table", "table-bordered", "border-success", "basket-table", "table-striped");

        let thead = document.createElement("thead");
        let thead_tr = document.createElement("tr");

        let columns = ["#", "Nom du produit", "Prix unitaire (HT)", "Prix unitaire (TTC)", "Dont réduction (%)", "Quantité", "Sous Total (TTC)", "Supprimer ?"]

        for (let i = 0; i < columns.length; i++) {
            let th = document.createElement("th");
            th.setAttribute("scope", "col");
            let text = document.createTextNode(columns[i]);
            th.appendChild(text);
            thead_tr.appendChild(th);
        }

        thead.appendChild(thead_tr);
        table.appendChild(thead);

        let tbody = document.createElement("tbody");

        let keys_basket = ["product_name", "price_exact_ht", "price_exact_ttc", "effective_reduction", "input_html_quantity", "price_exact_ttc_with_quantity", "input_html_remove", "form_errors"];
        let prefix_values = ["", "", "", "-", "", "", "", ""];
        let suffix_values = ["", "€", "€", "%", "", "€", "", ""];

        let all = basket["__all__"];
        delete basket["__all__"];

        let formset_management = basket["formset_management"];
        delete basket["formset_management"];

        let csrf_token = basket["csrf_token"];
        delete basket["csrf_token"];

        let keys_basket_all = ["price_exact_ttc_with_quantity__sum"];

        let i = 1;
        for (const keysBasketKey in basket) {
            let tbody_tr = document.createElement("tr");

            let data = {};
            if (basket.hasOwnProperty(keysBasketKey)) {
                data = basket[keysBasketKey];
            }

            let th = document.createElement("th");
            th.setAttribute("scope", "row");
            let text = document.createTextNode(i.toString());
            th.appendChild(text);
            tbody_tr.appendChild(th);

            let j = 0;
            for (const key of keys_basket) {
                let td = document.createElement("td");
                let info = "";
                if (data.hasOwnProperty(key)) {
                    info = data[key];
                }

                if (j === 4 || j === 6) {
                    td.innerHTML = info;

                    if (j === 4) {
                        let select = td.querySelector(":scope select");
                        select.addEventListener("change", add_save_button(modal_form_container_footer));
                    } else if (j === 6) {
                        let input = td.querySelector(":scope input");
                        input.addEventListener("change", add_save_button(modal_form_container_footer));
                    }
                } else if (j === 7) {
                    if (info === "") {
                        continue;
                    }

                    if (errors_form === null) {
                        errors_form = document.createElement("ul");
                    }
                    let li_product = document.createElement("li");
                    text = document.createTextNode(data["product_name"]);
                    li_product.appendChild(text);
                    li_product.insertAdjacentHTML("beforeend", info);
                    errors_form.appendChild(li_product);
                } else {
                    if (j === 1 || j === 2 || j === 3 || j === 5) {
                        if (j === 3 && parseInt(info) === 0) {
                            info = "Pas de reduction.";
                        } else {
                            info = parseFloat(info);
                            info = prefix_values[j] + info.toFixed(2).toString() + suffix_values[j];
                        }
                    }

                    text = document.createTextNode(info);
                    td.appendChild(text);
                }

                tbody_tr.appendChild(td);
                j++;
            }

            tbody.appendChild(tbody_tr);

            i++;
        }

        let tbody_tr = document.createElement("tr");

        let td = document.createElement("td");
        let strong = document.createElement("strong");
        let text = document.createTextNode("Total (TTC)");
        strong.appendChild(text);
        td.appendChild(strong);
        tbody_tr.appendChild(td);

        td = document.createElement("td");
        td.setAttribute("colspan", "5");
        tbody_tr.appendChild(td);

        td = document.createElement("td");
        strong = document.createElement("strong");
        text = document.createTextNode(parseFloat(all[keys_basket_all[0]]).toFixed(2) + "€");
        strong.appendChild(text);
        td.appendChild(strong);
        tbody_tr.appendChild(td);

        td = document.createElement("td");
        tbody_tr.appendChild(td);

        tbody.appendChild(tbody_tr);

        table.appendChild(tbody);

        table.classList.add("modal-body");

        let form = create_form_csrf(csrf_token, url_get_basket);
        form.insertAdjacentHTML("beforeend", formset_management);

        if (errors_form !== null) {
            form.appendChild(errors_form);
        }

        form.appendChild(table);
        form.appendChild(modal_form_container_footer);

        form.addEventListener("submit", post_basket);

        return form;
    }

    function status200() {
        let basket = httpRequest.response;
        let modal_body = basket_modal.querySelector(":scope .modal-body");

        if (Object.keys(basket).length > 0) {
            basket_save_button = false;
            let form = construct_basket_form(basket);
            modal_form_container.innerHTML = "";
            modal_form_container.appendChild(form);
            get_booking();
        } else {
            let div = document.createElement("div");
            let text = document.createTextNode("Votre panier est vide.");
            div.appendChild(text);
            modal_body.innerHTML = "";
            modal_body.appendChild(div);
        }
    }

    function onload_bakset() {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
            if (httpRequest.status === 200) {
                setTimeout(status200, 500);
            } else {
                alert('Il y a eu un problème avec la requête.');
            }
        }
    }

    function onload_booking() {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
            if (httpRequest.status === 200) {
                let data = httpRequest.response;
                if (data.hasOwnProperty("redirect")) {
                    window.location.href = data["redirect"];
                } else if (data.hasOwnProperty("reload")) {
                    window.location.reload();
                } else {
                    let modal_form_container_footer = modal_footer_clone.cloneNode(true);
                    modal_form_container.appendChild(modal_form_container_footer);

                    setTimeout(function () {
                        let form = create_form_csrf(data["csrf_token"], url_get_booking);
                        let button_validation = document.createElement("button");
                        button_validation.setAttribute("type", "submit");
                        button_validation.classList.add("btn", "btn-success");
                        text = document.createTextNode("Reserver");
                        button_validation.appendChild(text);
                        form.appendChild(button_validation);
                        form.addEventListener("submit", post_booking);

                        if (data.hasOwnProperty("form_errors")) {
                            form.insertAdjacentHTML("afterbegin", data["form_errors"]);
                        }

                        modal_form_container_footer.appendChild(form);
                    }, 500);
                }
            } else {
                alert('Il y a eu un problème avec la requête.');
            }
        }
    }

    function get_booking() {
        if (!httpRequest) {
            alert('Abandon :( Impossible de créer une instance de XMLHTTP');
            return false;
        }

        httpRequest.onload = onload_booking;
        httpRequest.open('GET', url_get_booking);
        httpRequest.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        httpRequest.responseType = 'json';
        httpRequest.send();
    }

    function get_basket() {
        if (basket_modal_showed) {
            return false;
        }

        basket_modal_showed = true;

        if (!httpRequest) {
            alert('Abandon :( Impossible de créer une instance de XMLHTTP');
            return false;
        }

        httpRequest.onload = onload_bakset;
        httpRequest.open('GET', url_get_basket);
        httpRequest.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        httpRequest.responseType = 'json';
        httpRequest.send();
    }

    function post_basket(event) {
        event.preventDefault();
        if (!httpRequest) {
            alert('Abandon :( Impossible de créer une instance de XMLHTTP');
            return false;
        }

        modal_form_container.innerHTML = "";
        modal_form_container.appendChild(spinner.cloneNode(true));
        modal_form_container.appendChild(modal_footer_clone.cloneNode(true));

        httpRequest.onload = onload_bakset;
        httpRequest.open('POST', url_get_basket, true);
        httpRequest.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        httpRequest.responseType = 'json';
        httpRequest.send(new FormData(event.currentTarget));
    }

    function post_booking(event) {
        event.preventDefault();
        if (!httpRequest) {
            alert('Abandon :( Impossible de créer une instance de XMLHTTP');
            return false;
        }

        httpRequest.onload = onload_booking;
        httpRequest.open('POST', url_get_booking, true);
        httpRequest.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        httpRequest.responseType = 'json';
        httpRequest.send(new FormData(event.currentTarget));
    }

    basket_modal.addEventListener('show.bs.modal', get_basket);
</script>

{% block body_js %}

{% endblock %}

</body>
</html>